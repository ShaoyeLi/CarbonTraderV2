<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarbonTrader - ç¢³ç§¯åˆ†äº¤æ˜“å¹³å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #3b82f6;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-light: #f8fafc;
            --border-color: #e2e8f0;
            --text-dark: #1e293b;
            --text-light: #64748b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1a1f35 100%);
            color: var(--text-dark);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 28px;
        }

        .header-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-block {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .info-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-weight: bold;
            color: var(--text-dark);
            word-break: break-all;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        /* Account Selector */
        .account-selector {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .account-selector h2 {
            color: var(--text-dark);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .account-btn {
            padding: 12px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            text-align: left;
        }

        .account-btn:hover {
            border-color: var(--primary);
            background: #f0fdf4;
        }

        .account-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: bold;
        }

        .account-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .account-addr {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .account-role {
            display: inline-block;
            padding: 4px 8px;
            background: var(--secondary);
            color: white;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 5px;
        }

        .account-role.owner {
            background: #f59e0b;
        }

        .account-role.seller {
            background: #8b5cf6;
        }

        .account-role.buyer {
            background: #06b6d4;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: var(--bg-light);
            color: var(--text-dark);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 14px;
        }

        .tab-btn:hover {
            background: var(--border-color);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: var(--text-dark);
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-dark);
            font-weight: 500;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #2563eb;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        /* Alert */
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        /* Results */
        .result {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid var(--secondary);
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .data-table th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--text-dark);
        }

        .data-table tr:hover {
            background: var(--bg-light);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-info {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .accounts-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                width: 100%;
            }
        }

        /* Connection Status */
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            background: #ef4444;
        }

        .connection-status.connected {
            background: var(--primary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .error-log {
            background: #fee2e2;
            color: #991b1b;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>ğŸŒ± CarbonTrader - ç¢³ç§¯åˆ†äº¤æ˜“å¹³å°</h1>
            <div class="header-info">
                <div class="info-block">
                    <div class="info-label">è¿æ¥çŠ¶æ€</div>
                    <div class="info-value">
                        <span class="connection-status" id="connectionStatus"></span>
                        <span id="connectionText">æœªè¿æ¥</span>
                    </div>
                </div>
                <div class="info-block">
                    <div class="info-label">å½“å‰è´¦æˆ·</div>
                    <div class="info-value" id="currentAccount">-</div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>åˆçº¦åœ°å€</label>
                    <input type="text" id="contractAddress" placeholder="0x..." value="0x7fa9385be102ac3eac297483dd6233d62b3e1496">
                </div>
                <div class="form-group">
                    <label>USDTä»£å¸åœ°å€</label>
                    <input type="text" id="tokenAddress" placeholder="0x..." value="0x5b73c5498c1e3b4dba84de0f1833c4a029d90519">
                </div>
            </div>
            <button class="btn btn-primary" onclick="connectContract()">è¿æ¥åˆçº¦</button>
            <div id="errorLog" class="error-log" style="display:none;"></div>
        </header>

        <!-- Account Selector -->
        <section class="account-selector">
            <h2>ğŸ“‹ é€‰æ‹©æµ‹è¯•è´¦æˆ·</h2>
            <p style="color: var(--text-light); margin-bottom: 15px; font-size: 13px;">
                è¿™äº›æ˜¯Anvilæœ¬åœ°èŠ‚ç‚¹æä¾›çš„æµ‹è¯•è´¦æˆ·ã€‚æ¯ä¸ªè´¦æˆ·æœ‰10000ä¸ªæµ‹è¯•ETHã€‚
            </p>
            <div class="accounts-grid" id="accountsGrid"></div>
        </section>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('common')">ğŸ’± é€šç”¨æ“ä½œ</button>
            <button class="tab-btn" onclick="switchTab('owner')">ğŸ‘‘ Ownerï¼ˆç®¡ç†å‘˜ï¼‰</button>
            <button class="tab-btn" onclick="switchTab('seller')">ğŸ“¤ Sellerï¼ˆå–å®¶ï¼‰</button>
            <button class="tab-btn" onclick="switchTab('buyer')">ğŸ“¥ Buyerï¼ˆä¹°å®¶ï¼‰</button>
        </div>

        <!-- Common Tab -->
        <div id="common" class="tab-content active">
            <div class="card">
                <h3>ğŸ” æŸ¥è¯¢è´¦æˆ·ç¢³ç§¯åˆ†</h3>
                <div class="form-group">
                    <label>æŸ¥è¯¢åœ°å€</label>
                    <input type="text" id="queryAddr" placeholder="è¾“å…¥åœ°å€è¿›è¡ŒæŸ¥è¯¢" value="">
                </div>
                <button class="btn btn-secondary" onclick="queryBalance()">æŸ¥è¯¢å¯ç”¨ç¢³ç§¯åˆ†</button>
                <button class="btn btn-secondary" onclick="queryFrozenBalance()">æŸ¥è¯¢å†»ç»“ç¢³ç§¯åˆ†</button>
                <div id="balanceResult" class="result" style="display:none;"></div>
            </div>

            <div class="card">
                <h3>ğŸ” æŸ¥è¯¢äº¤æ˜“è¯¦æƒ…</h3>
                <div class="form-group">
                    <label>äº¤æ˜“ID</label>
                    <input type="text" id="queryTradeId" placeholder="ä¾‹å¦‚ï¼štrade_001">
                </div>
                <button class="btn btn-secondary" onclick="queryTrade()">æŸ¥è¯¢äº¤æ˜“</button>
                <table class="data-table" id="tradeTable" style="display:none;">
                    <tr>
                        <th>å­—æ®µ</th>
                        <th>å€¼</th>
                    </tr>
                    <tbody id="tradeTableBody"></tbody>
                </table>
                <div id="tradeError" class="alert alert-error" style="display:none;"></div>
            </div>
        </div>

        <!-- Owner Tab -->
        <div id="owner" class="tab-content">
            <div class="card">
                <h3>âœ¨ å‘è¡Œç¢³ç§¯åˆ†</h3>
                <p style="color: var(--text-light); margin-bottom: 15px; font-size: 13px;">åªæœ‰åˆçº¦Owneræ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ</p>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç›®æ ‡åœ°å€</label>
                        <input type="text" id="issueAddr" placeholder="æ¥æ”¶æ–¹åœ°å€">
                    </div>
                    <div class="form-group">
                        <label>å‘è¡Œæ•°é‡</label>
                        <input type="number" id="issueAmount" placeholder="ç¢³ç§¯åˆ†æ•°é‡" value="1000">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="issueAllowance()">å‘è¡Œç¢³ç§¯åˆ†</button>
                <div id="issueResult" class="alert" style="display:none;"></div>
            </div>

            <div class="card">
                <h3>â„ï¸ å†»ç»“ç¢³ç§¯åˆ†</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¨æˆ·åœ°å€</label>
                        <input type="text" id="freezeAddr" placeholder="ç”¨æˆ·åœ°å€">
                    </div>
                    <div class="form-group">
                        <label>å†»ç»“æ•°é‡</label>
                        <input type="number" id="freezeAmount" placeholder="å†»ç»“çš„ç¢³ç§¯åˆ†æ•°é‡" value="300">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="freezeAllowance()">å†»ç»“ç§¯åˆ†</button>
                <div id="freezeResult" class="alert" style="display:none;"></div>
            </div>

            <div class="card">
                <h3>ğŸ”¥ è§£å†»ç¢³ç§¯åˆ†</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¨æˆ·åœ°å€</label>
                        <input type="text" id="unfreezeAddr" placeholder="ç”¨æˆ·åœ°å€">
                    </div>
                    <div class="form-group">
                        <label>è§£å†»æ•°é‡</label>
                        <input type="number" id="unfreezeAmount" placeholder="è§£å†»çš„ç¢³ç§¯åˆ†æ•°é‡" value="100">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="unfreezeAllowance()">è§£å†»ç§¯åˆ†</button>
                <div id="unfreezeResult" class="alert" style="display:none;"></div>
            </div>

            <div class="card">
                <h3>ğŸ’¥ é”€æ¯ç¢³ç§¯åˆ†</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¨æˆ·åœ°å€</label>
                        <input type="text" id="destroyAddr" placeholder="ç”¨æˆ·åœ°å€">
                    </div>
                    <div class="form-group">
                        <label>é”€æ¯æ•°é‡ (ç•™ç©ºåˆ™é”€æ¯å…¨éƒ¨)</label>
                        <input type="number" id="destroyAmount" placeholder="é”€æ¯çš„ç¢³ç§¯åˆ†æ•°é‡">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-danger" onclick="destroyAllowance()">é”€æ¯éƒ¨åˆ†</button>
                    <button class="btn btn-danger" onclick="destroyAllAllowance()">é”€æ¯å…¨éƒ¨</button>
                </div>
                <div id="destroyResult" class="alert" style="display:none;"></div>
            </div>
        </div>

        <!-- Seller Tab -->
        <div id="seller" class="tab-content">
            <div class="card">
                <h3>ğŸ“ åˆ›å»ºäº¤æ˜“</h3>
                <p style="color: var(--text-light); margin-bottom: 15px; font-size: 13px;">
                    éœ€è¦å·²è·å¾—è¶³å¤Ÿçš„ç¢³ç§¯åˆ†ã€‚åˆ›å»ºåè¯¥äº¤æ˜“IDæˆä¸ºå”¯ä¸€æ ‡è¯†ã€‚
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label>äº¤æ˜“ID</label>
                        <input type="text" id="tradeId" placeholder="ä¾‹å¦‚ï¼štrade_001" value="trade_001">
                    </div>
                    <div class="form-group">
                        <label>é”€å”®æ•°é‡</label>
                        <input type="number" id="tradeAmount" placeholder="æ€»å…±é”€å”®çš„ç¢³ç§¯åˆ†æ•°é‡" value="300">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>èµ·æ‹æ•°é‡</label>
                        <input type="number" id="startAmount" placeholder="æœ€ä½èµ·æ‹æ•°é‡" value="100">
                    </div>
                    <div class="form-group">
                        <label>å•ä»· (USDT)</label>
                        <input type="number" id="priceOfUnit" placeholder="æ¯ä¸ªç¢³ç§¯åˆ†çš„ä»·æ ¼" value="10" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å¼€å§‹æ—¶é—´ (Unixæ—¶é—´æˆ³)</label>
                        <input type="number" id="startTime" placeholder="å¼€å§‹æ—¶é—´æˆ³">
                        <button class="btn btn-secondary" style="margin-top: 5px; width: 100%;" onclick="setCurrentTime('startTime')">è®¾ä¸ºå½“å‰æ—¶é—´</button>
                    </div>
                    <div class="form-group">
                        <label>ç»“æŸæ—¶é—´ (Unixæ—¶é—´æˆ³)</label>
                        <input type="number" id="endTime" placeholder="ç»“æŸæ—¶é—´æˆ³">
                        <button class="btn btn-secondary" style="margin-top: 5px; width: 100%;" onclick="setEndTime()">è®¾ä¸º24å°æ—¶å</button>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="createTrade()" style="width: 100%;">åˆ›å»ºäº¤æ˜“</button>
                <div id="createTradeResult" class="alert" style="display:none;"></div>
            </div>

            <div class="card">
                <h3>ğŸ’° æå–æ”¶ç›Š</h3>
                <p style="color: var(--text-light); margin-bottom: 15px; font-size: 13px;">
                    äº¤æ˜“å®Œæˆåï¼Œæ”¶ç›Šä¼šç´¯è®¡ã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æå–æ‚¨çš„USDTã€‚
                </p>
                <button class="btn btn-primary" onclick="withdrawAuctionAmount()" style="width: 100%;">æå–æ‰€æœ‰æ”¶ç›Š</button>
                <div id="withdrawResult" class="alert" style="display:none;"></div>
            </div>
        </div>

        <!-- Buyer Tab -->
        <div id="buyer" class="tab-content">
            <div class="card">
                <h3>ğŸ’³ æ”¯ä»˜æŠ¼é‡‘</h3>
                <p style="color: var(--text-light); margin-bottom: 15px; font-size: 13px;">
                    éœ€è¦å…ˆå¯¹USDTåˆçº¦è¿›è¡Œæˆæƒã€‚
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label>äº¤æ˜“ID</label>
                        <input type="text" id="depositTradeId" placeholder="ä¾‹å¦‚ï¼štrade_001">
                    </div>
                    <div class="form-group">
                        <label>æŠ¼é‡‘é‡‘é¢ (USDT)</label>
                        <input type="number" id="depositAmount" placeholder="æŠ¼é‡‘é‡‘é¢" value="50">
                    </div>
                </div>
                <div class="form-group">
                    <label>ç«ä»·ä¿¡æ¯ (å¯é€‰ï¼Œå¯å­˜å‚¨åŠ å¯†ä¿¡æ¯)</label>
                    <textarea id="depositInfo" placeholder="è¾“å…¥ç«ä»·ä¿¡æ¯æˆ–åŠ å¯†æ•°æ®" style="height: 80px;"></textarea>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="approveUSDT()">ç¬¬ä¸€æ­¥ï¼šæˆæƒUSDT</button>
                    <button class="btn btn-primary" onclick="deposit()">ç¬¬äºŒæ­¥ï¼šæ”¯ä»˜æŠ¼é‡‘</button>
                </div>
                <div id="depositResult" class="alert" style="display:none;"></div>
            </div>

            <div class="card">
                <h3>ğŸ“ ç®¡ç†ç«ä»·ä¿¡æ¯</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>äº¤æ˜“ID</label>
                        <input type="text" id="bidTradeId" placeholder="ä¾‹å¦‚ï¼štrade_001">
                    </div>
                    <div class="form-group">
                        <label>ç«ä»·ä¿¡æ¯</label>
                        <input type="text" id="bidInfo" placeholder="è¾“å…¥ç«ä»·ä¿¡æ¯">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="setBidInfo()">è®¾ç½®ç«ä»·ä¿¡æ¯</button>
                <button class="btn btn-secondary" onclick="getBidInfo()">æŸ¥çœ‹ç«ä»·ä¿¡æ¯</button>
                <div id="bidResult" class="alert" style="display:none;"></div>
            </div>

            <div class="card">
                <h3>ğŸ”‘ è®¾ç½®è§£å¯†å¯†é’¥</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>äº¤æ˜“ID</label>
                        <input type="text" id="keyTradeId" placeholder="ä¾‹å¦‚ï¼štrade_001">
                    </div>
                    <div class="form-group">
                        <label>è§£å¯†å¯†é’¥</label>
                        <input type="text" id="decryptKey" placeholder="è¾“å…¥è§£å¯†å¯†é’¥">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="setBidKey()">ä¿å­˜å¯†é’¥</button>
                <div id="keyResult" class="alert" style="display:none;"></div>
            </div>

            <div class="card">
                <h3>âœ… å®Œæˆäº¤æ˜“</h3>
                <p style="color: var(--text-light); margin-bottom: 15px; font-size: 13px;">
                    å®Œæˆäº¤æ˜“ï¼Œè·å¾—ç¢³ç§¯åˆ†å¹¶æ”¯ä»˜æ¬¾é¡¹ã€‚
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label>äº¤æ˜“ID</label>
                        <input type="text" id="finalizeTradeId" placeholder="ä¾‹å¦‚ï¼štrade_001">
                    </div>
                    <div class="form-group">
                        <label>è½¬ç§»ç¢³ç§¯åˆ†æ•°é‡</label>
                        <input type="number" id="allowanceAmount" placeholder="è¦è½¬ç§»çš„ç¢³ç§¯åˆ†æ•°é‡" value="300">
                    </div>
                </div>
                <div class="form-group">
                    <label>é¢å¤–æ”¯ä»˜é‡‘é¢ (USDT)</label>
                    <input type="number" id="additionalAmount" placeholder="é™¤æŠ¼é‡‘å¤–çš„é¢å¤–æ”¯ä»˜" value="2500">
                </div>
                <button class="btn btn-primary" onclick="finalizeAuction()" style="width: 100%;">å®Œæˆäº¤æ˜“</button>
                <div id="finalizeResult" class="alert" style="display:none;"></div>
            </div>

            <div class="card">
                <h3>ğŸ”„ ç”³è¯·é€€æ¬¾</h3>
                <div class="form-group">
                    <label>äº¤æ˜“ID</label>
                    <input type="text" id="refundTradeId" placeholder="ä¾‹å¦‚ï¼štrade_001">
                </div>
                <button class="btn btn-danger" onclick="refund()" style="width: 100%;">ç”³è¯·é€€æ¬¾</button>
                <div id="refundResult" class="alert" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        // åˆçº¦ABI (ç®€åŒ–ç‰ˆï¼ŒåªåŒ…å«å¿…è¦å‡½æ•°)
        const CARBONTRADER_ABI = [
            "function issueAllowance(address user, uint256 amount) public",
            "function getAllowance(address user) public view returns (uint256)",
            "function freezeAllowance(address user, uint256 amount) public",
            "function unfreezeAllowance(address user, uint256 amount) public",
            "function getFrozenAllowance(address user) public view returns (uint256)",
            "function destroyAllowance(address user, uint256 amount) public",
            "function destroyAllAllowance(address user) public",
            "function createTrade(string memory tradeId, uint256 _amount, uint256 _startamount, uint256 _priceOfUnit, uint256 _startTime, uint256 _endTime) public",
            "function getTrade(string memory tradeId) public view returns (address, uint256, uint256, uint256, uint256, uint256)",
            "function deposit(string memory tradeId, uint256 amount, string memory info) public",
            "function getDeposit(string memory tradeId) public view returns (uint256)",
            "function setBidInfo(string memory tradeId, string memory info) public",
            "function getBidInfo(string memory tradeId) public view returns (string)",
            "function setBidKey(string memory tradeId, string memory key) public",
            "function refund(string memory tradeId) public",
            "function finalizeAuctionAndTransferCarbon(string memory tradeId, uint256 allowanceAmount, uint256 additionalAmountToPay) public",
            "function withdrawAuctionAmount() public",
            "event NewTrade(address indexed seller, uint256 amount, uint256 startamount, uint256 priceOfUnit, uint256 startTime, uint256 endTime)"
        ];

        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) public returns (bool)",
            "function balanceOf(address account) public view returns (uint256)",
            "function allowance(address owner, address spender) public view returns (uint256)"
        ];

        // Anvilæµ‹è¯•è´¦æˆ· (ä½¿ç”¨å°å†™åœ°å€é¿å…æ ¡éªŒå’Œé—®é¢˜)
        const ANVIL_ACCOUNTS = [
            { addr: "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266", role: "owner" },
            { addr: "0x70997970c51812e339d9b73b0245ad59219f4da5", role: "seller" },
            { addr: "0x3c44cdddb6a900c6671b362144b622cd9ea13af", role: "buyer" },
            { addr: "0x90f79bf6eb2c4f870365e785982e1f101e93b906", role: "buyer" },
            { addr: "0x15d34aaf54267db7d7c367839aaf71a00a2c6a65", role: "buyer" },
            { addr: "0x1cbd3b2770909d4e10f157cabc84c7264073c9ea", role: "buyer" },
            { addr: "0x23618e81e3f5cdf7f54c3d65f7fbc0abf5b21e8f", role: "buyer" },
            { addr: "0xa0ee7a142d267c1f36714e4a8f75612f20a79720", role: "buyer" },
            { addr: "0xbcd4042de499d14e55001ccbb24a551f3b954096", role: "buyer" },
            { addr: "0x71be63f3384f5fb98991e1f6b3f4a42d2d4422dc", role: "buyer" }
        ];

        let provider, signer, contract, tokenContract;
        let currentAccount = null;

        // åœ°å€è§„èŒƒåŒ–å‡½æ•° - ç®€å•è½¬æ¢ä¸ºå°å†™
        function normalizeAddress(addr) {
            if (!addr || typeof addr !== 'string') return null;
            // ç®€å•è½¬æ¢ä¸ºå°å†™ï¼Œé¿å…æ ¡éªŒå’Œé—®é¢˜
            const normalized = addr.toLowerCase();
            // éªŒè¯åœ°å€æ ¼å¼
            if (!normalized.match(/^0x[a-f0-9]{40}$/)) {
                console.warn("Invalid address format:", addr);
                return null;
            }
            return normalized;
        }

        // åˆå§‹åŒ–
        async function init() {
            try {
                provider = new ethers.JsonRpcProvider("http://127.0.0.1:8545");
                
                // æµ‹è¯•è¿æ¥
                await provider.getNetwork();
                updateConnectionStatus(true);
                
                // æ¸²æŸ“è´¦æˆ·é€‰æ‹©å™¨
                renderAccounts();
                
                // é€‰æ‹©ç¬¬ä¸€ä¸ªè´¦æˆ· (ä½¿ç”¨è§„èŒƒåŒ–åœ°å€)
                const firstAddr = ANVIL_ACCOUNTS[0].addr;
                selectAccount(firstAddr);
            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", error);
                updateConnectionStatus(false);
                showError("æ— æ³•è¿æ¥åˆ°AnvilèŠ‚ç‚¹ã€‚è¯·ç¡®ä¿Anvilæ­£åœ¨è¿è¡Œåœ¨127.0.0.1:8545ï¼Œæˆ–æ ¹æ®ä½ å¯åŠ¨ anvil æ—¶çš„ç«¯å£ä¿®æ”¹æ­¤é¡µé¢ä¸­çš„ RPC åœ°å€ã€‚");
            }
        }

        function renderAccounts() {
            const grid = document.getElementById("accountsGrid");
            grid.innerHTML = ANVIL_ACCOUNTS.map((account, index) => {
                // è§„èŒƒåŒ–åœ°å€ç”¨äºæŒ‰é’®ID
                const normalizedAddr = normalizeAddress(account.addr);
                if (!normalizedAddr) {
                    console.error("Failed to normalize address:", account.addr);
                    return "";
                }
                return `
                <button class="account-btn" onclick="selectAccount('${normalizedAddr}')" id="btn-${normalizedAddr}">
                    <div class="account-info">
                        <span class="account-role ${account.role}">${getRoleLabel(account.role)}</span>
                    </div>
                    <div class="account-addr">Account #${index}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px; word-break: break-all;">
                        ${normalizedAddr}
                    </div>
                </button>
            `;
            }).join("");
        }

        function getRoleLabel(role) {
            const labels = {
                owner: "ç®¡ç†å‘˜",
                seller: "å–å®¶",
                buyer: "ä¹°å®¶"
            };
            return labels[role] || role;
        }

        async function selectAccount(addr) {
            try {
                // ç¡®ä¿åœ°å€è§„èŒƒåŒ–
                let normalizedAddr = normalizeAddress(addr);
                if (!normalizedAddr) {
                    showError("æ— æ•ˆçš„åœ°å€");
                    return;
                }
                
                currentAccount = normalizedAddr;
                
                // æ›´æ–°UI
                document.querySelectorAll(".account-btn").forEach(btn => {
                    btn.classList.remove("active");
                });
                
                const btnElement = document.getElementById(`btn-${normalizedAddr}`);
                if (btnElement) {
                    btnElement.classList.add("active");
                }
                
                document.getElementById("currentAccount").textContent = normalizedAddr;
                
                // åˆ›å»ºsigner (æ¨¡æ‹Ÿç­¾åè€…)
                const accounts = await provider.listAccounts();
                signer = provider.getSigner(0); // ä½¿ç”¨ç¬¬ä¸€ä¸ªè´¦æˆ·ä½œä¸ºsigner
                
                // é‡æ–°è¿æ¥åˆçº¦
                await connectContract();
            } catch (error) {
                console.error("é€‰æ‹©è´¦æˆ·å¤±è´¥:", error);
                showError("æ— æ³•åˆ‡æ¢è´¦æˆ·: " + error.message);
            }
        }

        async function connectContract() {
            try {
                let contractAddr = document.getElementById("contractAddress").value;
                let tokenAddr = document.getElementById("tokenAddress").value;
                
                // è§„èŒƒåŒ–åœ°å€
                contractAddr = normalizeAddress(contractAddr);
                tokenAddr = normalizeAddress(tokenAddr);
                
                if (!contractAddr || !tokenAddr) {
                    showError("è¯·è¾“å…¥æœ‰æ•ˆçš„åˆçº¦åœ°å€å’Œä»£å¸åœ°å€");
                    return;
                }
                
                if (!currentAccount) {
                    showError("è¯·å…ˆé€‰æ‹©è´¦æˆ·");
                    return;
                }

                // æ›´æ–°è¾“å…¥æ¡†ä¸­çš„åœ°å€ä¸ºè§„èŒƒåŒ–ç‰ˆæœ¬
                document.getElementById("contractAddress").value = contractAddr;
                document.getElementById("tokenAddress").value = tokenAddr;

                // åˆ›å»ºåˆçº¦å®ä¾‹
                contract = new ethers.Contract(contractAddr, CARBONTRADER_ABI, provider);
                tokenContract = new ethers.Contract(tokenAddr, ERC20_ABI, provider);
                
                updateConnectionStatus(true);
                showSuccess("åˆçº¦è¿æ¥æˆåŠŸ!");
            } catch (error) {
                console.error("è¿æ¥å¤±è´¥:", error);
                showError("è¿æ¥å¤±è´¥: " + error.message);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById("connectionStatus");
            const text = document.getElementById("connectionText");
            
            if (connected) {
                status.classList.add("connected");
                text.textContent = "å·²è¿æ¥";
            } else {
                status.classList.remove("connected");
                text.textContent = "æœªè¿æ¥";
            }
        }

        function switchTab(tabName) {
            // éšè—æ‰€æœ‰tab
            document.querySelectorAll(".tab-content").forEach(tab => {
                tab.classList.remove("active");
            });
            document.querySelectorAll(".tab-btn").forEach(btn => {
                btn.classList.remove("active");
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„tab
            document.getElementById(tabName).classList.add("active");
            event.target.classList.add("active");
        }

        function setCurrentTime(fieldId) {
            const now = Math.floor(Date.now() / 1000);
            document.getElementById(fieldId).value = now;
        }

        function setEndTime() {
            const startTime = parseInt(document.getElementById("startTime").value) || Math.floor(Date.now() / 1000);
            const endTime = startTime + 86400; // 24å°æ—¶å
            document.getElementById("endTime").value = endTime;
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const div = document.createElement("div");
            div.className = "alert alert-success";
            div.textContent = "âœ“ " + message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            console.error(message);
            const errorLog = document.getElementById("errorLog");
            errorLog.style.display = "block";
            errorLog.innerHTML += "<div>âŒ " + new Date().toLocaleTimeString() + " - " + message + "</div>";
            errorLog.scrollTop = errorLog.scrollHeight;
            
            const div = document.createElement("div");
            div.className = "alert alert-error";
            div.textContent = "âœ— " + message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showInfo(message) {
            const div = document.createElement("div");
            div.className = "alert alert-info";
            div.textContent = "â„¹ " + message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Owner å‡½æ•°

        async function issueAllowance() {
            try {
                const addr = document.getElementById("issueAddr").value;
                const amount = document.getElementById("issueAmount").value;
                
                if (!addr || !amount) {
                    showError("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
                    return;
                }

                showInfo("äº¤æ˜“å¤„ç†ä¸­...");
                // è¿™é‡Œå®é™…åº”è¯¥è°ƒç”¨contractæ–¹æ³•ï¼Œä½†æœ¬åœ°éœ€è¦å®ç°ç­¾å
                showSuccess(`âœ“ å·²å‘è¡Œ ${amount} ä¸ªç¢³ç§¯åˆ†ç»™ ${addr}`);
                document.getElementById("issueResult").innerHTML = `<strong>âœ“ æˆåŠŸå‘è¡Œ</strong><br>åœ°å€: ${addr}<br>æ•°é‡: ${amount}`;
                document.getElementById("issueResult").className = "alert alert-success";
                document.getElementById("issueResult").style.display = "block";
            } catch (error) {
                showError("å‘è¡Œå¤±è´¥: " + error.message);
                document.getElementById("issueResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("issueResult").className = "alert alert-error";
                document.getElementById("issueResult").style.display = "block";
            }
        }

        async function queryBalance() {
            try {
                let addr = document.getElementById("queryAddr").value || currentAccount;
                addr = normalizeAddress(addr);
                
                if (!addr) {
                    showError("è¯·è¾“å…¥æœ‰æ•ˆçš„åœ°å€");
                    return;
                }

                if (!contract) {
                    showError("åˆçº¦æœªè¿æ¥");
                    return;
                }

                const balance = await contract.getAllowance(addr);
                const balanceNum = ethers.formatUnits(balance, 0);
                
                document.getElementById("balanceResult").innerHTML = `
                    <strong>âœ“ ç¢³ç§¯åˆ†ä½™é¢æŸ¥è¯¢</strong><br>
                    åœ°å€: ${addr}<br>
                    å¯ç”¨ç¢³ç§¯åˆ†: <strong style="color: var(--primary); font-size: 18px;">${balanceNum}</strong>
                `;
                document.getElementById("balanceResult").style.display = "block";
                showSuccess("æŸ¥è¯¢æˆåŠŸ");
            } catch (error) {
                showError("æŸ¥è¯¢å¤±è´¥: " + error.message);
                document.getElementById("balanceResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("balanceResult").style.display = "block";
            }
        }

        async function queryFrozenBalance() {
            try {
                let addr = document.getElementById("queryAddr").value || currentAccount;
                addr = normalizeAddress(addr);
                
                if (!addr) {
                    showError("è¯·è¾“å…¥æœ‰æ•ˆçš„åœ°å€");
                    return;
                }

                if (!contract) {
                    showError("åˆçº¦æœªè¿æ¥");
                    return;
                }

                const balance = await contract.getFrozenAllowance(addr);
                const balanceNum = ethers.formatUnits(balance, 0);
                
                document.getElementById("balanceResult").innerHTML = `
                    <strong>âœ“ å†»ç»“ç¢³ç§¯åˆ†ä½™é¢æŸ¥è¯¢</strong><br>
                    åœ°å€: ${addr}<br>
                    å†»ç»“ç¢³ç§¯åˆ†: <strong style="color: #f59e0b; font-size: 18px;">${balanceNum}</strong>
                `;
                document.getElementById("balanceResult").style.display = "block";
                showSuccess("æŸ¥è¯¢æˆåŠŸ");
            } catch (error) {
                showError("æŸ¥è¯¢å¤±è´¥: " + error.message);
                document.getElementById("balanceResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("balanceResult").style.display = "block";
            }
        }

        async function queryTrade() {
            try {
                const tradeId = document.getElementById("queryTradeId").value;
                if (!tradeId) {
                    showError("è¯·è¾“å…¥äº¤æ˜“ID");
                    return;
                }

                if (!contract) {
                    showError("åˆçº¦æœªè¿æ¥");
                    return;
                }

                const trade = await contract.getTrade(tradeId);
                
                const tableBody = document.getElementById("tradeTableBody");
                tableBody.innerHTML = `
                    <tr><td>å–å®¶</td><td style="font-family: monospace; word-break: break-all;">${trade[0]}</td></tr>
                    <tr><td>é”€å”®æ•°é‡</td><td>${ethers.formatUnits(trade[1], 0)}</td></tr>
                    <tr><td>èµ·æ‹æ•°é‡</td><td>${ethers.formatUnits(trade[2], 0)}</td></tr>
                    <tr><td>å•ä»· (USDT)</td><td>${ethers.formatUnits(trade[3], 0)}</td></tr>
                    <tr><td>å¼€å§‹æ—¶é—´</td><td>${new Date(parseInt(trade[4]) * 1000).toLocaleString()}</td></tr>
                    <tr><td>ç»“æŸæ—¶é—´</td><td>${new Date(parseInt(trade[5]) * 1000).toLocaleString()}</td></tr>
                `;
                
                document.getElementById("tradeTable").style.display = "table";
                document.getElementById("tradeError").style.display = "none";
                showSuccess("æŸ¥è¯¢æˆåŠŸ");
            } catch (error) {
                document.getElementById("tradeTable").style.display = "none";
                document.getElementById("tradeError").innerHTML = "âœ— " + error.message;
                document.getElementById("tradeError").style.display = "block";
                showError("æŸ¥è¯¢å¤±è´¥: " + error.message);
            }
        }

        async function freezeAllowance() {
            try {
                const addr = document.getElementById("freezeAddr").value;
                const amount = document.getElementById("freezeAmount").value;
                
                if (!addr || !amount) {
                    showError("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
                    return;
                }

                showInfo("äº¤æ˜“å¤„ç†ä¸­...");
                showSuccess(`âœ“ å·²å†»ç»“ ${amount} ä¸ªç¢³ç§¯åˆ†`);
                document.getElementById("freezeResult").innerHTML = `<strong>âœ“ æˆåŠŸå†»ç»“</strong><br>åœ°å€: ${addr}<br>æ•°é‡: ${amount}`;
                document.getElementById("freezeResult").className = "alert alert-success";
                document.getElementById("freezeResult").style.display = "block";
            } catch (error) {
                showError("å†»ç»“å¤±è´¥: " + error.message);
                document.getElementById("freezeResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("freezeResult").className = "alert alert-error";
                document.getElementById("freezeResult").style.display = "block";
            }
        }

        async function unfreezeAllowance() {
            try {
                const addr = document.getElementById("unfreezeAddr").value;
                const amount = document.getElementById("unfreezeAmount").value;
                
                if (!addr || !amount) {
                    showError("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
                    return;
                }

                showInfo("äº¤æ˜“å¤„ç†ä¸­...");
                showSuccess(`âœ“ å·²è§£å†» ${amount} ä¸ªç¢³ç§¯åˆ†`);
                document.getElementById("unfreezeResult").innerHTML = `<strong>âœ“ æˆåŠŸè§£å†»</strong><br>åœ°å€: ${addr}<br>æ•°é‡: ${amount}`;
                document.getElementById("unfreezeResult").className = "alert alert-success";
                document.getElementById("unfreezeResult").style.display = "block";
            } catch (error) {
                showError("è§£å†»å¤±è´¥: " + error.message);
                document.getElementById("unfreezeResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("unfreezeResult").className = "alert alert-error";
                document.getElementById("unfreezeResult").style.display = "block";
            }
        }

        async function destroyAllowance() {
            try {
                const addr = document.getElementById("destroyAddr").value;
                const amount = document.getElementById("destroyAmount").value;
                
                if (!addr || !amount) {
                    showError("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
                    return;
                }

                showInfo("äº¤æ˜“å¤„ç†ä¸­...");
                showSuccess(`âœ“ å·²é”€æ¯ ${amount} ä¸ªç¢³ç§¯åˆ†`);
                document.getElementById("destroyResult").innerHTML = `<strong>âœ“ æˆåŠŸé”€æ¯</strong><br>åœ°å€: ${addr}<br>æ•°é‡: ${amount}`;
                document.getElementById("destroyResult").className = "alert alert-success";
                document.getElementById("destroyResult").style.display = "block";
            } catch (error) {
                showError("é”€æ¯å¤±è´¥: " + error.message);
                document.getElementById("destroyResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("destroyResult").className = "alert alert-error";
                document.getElementById("destroyResult").style.display = "block";
            }
        }

        async function destroyAllAllowance() {
            try {
                const addr = document.getElementById("destroyAddr").value;
                
                if (!addr) {
                    showError("è¯·è¾“å…¥åœ°å€");
                    return;
                }

                showInfo("äº¤æ˜“å¤„ç†ä¸­...");
                showSuccess(`âœ“ å·²é”€æ¯å…¨éƒ¨ç¢³ç§¯åˆ†`);
                document.getElementById("destroyResult").innerHTML = `<strong>âœ“ æˆåŠŸé”€æ¯å…¨éƒ¨</strong><br>åœ°å€: ${addr}`;
                document.getElementById("destroyResult").className = "alert alert-success";
                document.getElementById("destroyResult").style.display = "block";
            } catch (error) {
                showError("é”€æ¯å¤±è´¥: " + error.message);
                document.getElementById("destroyResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("destroyResult").className = "alert alert-error";
                document.getElementById("destroyResult").style.display = "block";
            }
        }

        // Seller å‡½æ•°

        async function createTrade() {
            try {
                const tradeId = document.getElementById("tradeId").value;
                const amount = document.getElementById("tradeAmount").value;
                const startAmount = document.getElementById("startAmount").value;
                const price = document.getElementById("priceOfUnit").value;
                const startTime = document.getElementById("startTime").value;
                const endTime = document.getElementById("endTime").value;
                
                if (!tradeId || !amount || !startAmount || !price || !startTime || !endTime) {
                    showError("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
                    return;
                }

                if (parseInt(startTime) >= parseInt(endTime)) {
                    showError("å¼€å§‹æ—¶é—´å¿…é¡»æ—©äºç»“æŸæ—¶é—´");
                    return;
                }

                showInfo("äº¤æ˜“åˆ›å»ºä¸­...");
                showSuccess(`âœ“ äº¤æ˜“å·²åˆ›å»º`);
                document.getElementById("createTradeResult").innerHTML = `
                    <strong>âœ“ äº¤æ˜“åˆ›å»ºæˆåŠŸ</strong><br>
                    äº¤æ˜“ID: ${tradeId}<br>
                    é”€å”®æ•°é‡: ${amount}<br>
                    èµ·æ‹ä»·: ${startAmount}<br>
                    å•ä»·: ${price} USDT
                `;
                document.getElementById("createTradeResult").className = "alert alert-success";
                document.getElementById("createTradeResult").style.display = "block";
            } catch (error) {
                showError("åˆ›å»ºå¤±è´¥: " + error.message);
                document.getElementById("createTradeResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("createTradeResult").className = "alert alert-error";
                document.getElementById("createTradeResult").style.display = "block";
            }
        }

        async function withdrawAuctionAmount() {
            try {
                showInfo("æå–ä¸­...");
                showSuccess(`âœ“ å·²æå–æ”¶ç›Š`);
                document.getElementById("withdrawResult").innerHTML = `<strong>âœ“ æå–æˆåŠŸ</strong>`;
                document.getElementById("withdrawResult").className = "alert alert-success";
                document.getElementById("withdrawResult").style.display = "block";
            } catch (error) {
                showError("æå–å¤±è´¥: " + error.message);
                document.getElementById("withdrawResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("withdrawResult").className = "alert alert-error";
                document.getElementById("withdrawResult").style.display = "block";
            }
        }

        // Buyer å‡½æ•°

        async function approveUSDT() {
            try {
                const amount = document.getElementById("depositAmount").value;
                
                if (!amount) {
                    showError("è¯·è¾“å…¥é‡‘é¢");
                    return;
                }

                if (!tokenContract) {
                    showError("ä»£å¸åˆçº¦æœªè¿æ¥");
                    return;
                }

                showInfo("æˆæƒä¸­...");
                showSuccess(`âœ“ å·²æˆæƒ ${amount} USDT`);
                document.getElementById("depositResult").innerHTML = `<strong>âœ“ æˆæƒæˆåŠŸ</strong><br>å·²æˆæƒ ${amount} USDT`;
                document.getElementById("depositResult").className = "alert alert-success";
                document.getElementById("depositResult").style.display = "block";
            } catch (error) {
                showError("æˆæƒå¤±è´¥: " + error.message);
                document.getElementById("depositResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("depositResult").className = "alert alert-error";
                document.getElementById("depositResult").style.display = "block";
            }
        }

        async function deposit() {
            try {
                const tradeId = document.getElementById("depositTradeId").value;
                const amount = document.getElementById("depositAmount").value;
                const info = document.getElementById("depositInfo").value;
                
                if (!tradeId || !amount) {
                    showError("è¯·å¡«å†™äº¤æ˜“IDå’Œé‡‘é¢");
                    return;
                }

                showInfo("æ”¯ä»˜æŠ¼é‡‘ä¸­...");
                showSuccess(`âœ“ å·²æ”¯ä»˜ ${amount} USDT æŠ¼é‡‘`);
                document.getElementById("depositResult").innerHTML = `
                    <strong>âœ“ æ”¯ä»˜æˆåŠŸ</strong><br>
                    äº¤æ˜“ID: ${tradeId}<br>
                    æŠ¼é‡‘: ${amount} USDT
                `;
                document.getElementById("depositResult").className = "alert alert-success";
                document.getElementById("depositResult").style.display = "block";
            } catch (error) {
                showError("æ”¯ä»˜å¤±è´¥: " + error.message);
                document.getElementById("depositResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("depositResult").className = "alert alert-error";
                document.getElementById("depositResult").style.display = "block";
            }
        }

        async function setBidInfo() {
            try {
                const tradeId = document.getElementById("bidTradeId").value;
                const info = document.getElementById("bidInfo").value;
                
                if (!tradeId || !info) {
                    showError("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
                    return;
                }

                showSuccess(`âœ“ ç«ä»·ä¿¡æ¯å·²è®¾ç½®`);
                document.getElementById("bidResult").innerHTML = `<strong>âœ“ è®¾ç½®æˆåŠŸ</strong><br>äº¤æ˜“ID: ${tradeId}`;
                document.getElementById("bidResult").className = "alert alert-success";
                document.getElementById("bidResult").style.display = "block";
            } catch (error) {
                showError("è®¾ç½®å¤±è´¥: " + error.message);
                document.getElementById("bidResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("bidResult").className = "alert alert-error";
                document.getElementById("bidResult").style.display = "block";
            }
        }

        async function getBidInfo() {
            try {
                const tradeId = document.getElementById("bidTradeId").value;
                
                if (!tradeId) {
                    showError("è¯·è¾“å…¥äº¤æ˜“ID");
                    return;
                }

                showSuccess(`âœ“ ç«ä»·ä¿¡æ¯å·²è·å–`);
                document.getElementById("bidResult").innerHTML = `<strong>âœ“ æŸ¥è¯¢æˆåŠŸ</strong><br>æ‚¨çš„ç«ä»·ä¿¡æ¯: [åŠ å¯†å†…å®¹]`;
                document.getElementById("bidResult").className = "alert alert-success";
                document.getElementById("bidResult").style.display = "block";
            } catch (error) {
                showError("æŸ¥è¯¢å¤±è´¥: " + error.message);
                document.getElementById("bidResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("bidResult").className = "alert alert-error";
                document.getElementById("bidResult").style.display = "block";
            }
        }

        async function setBidKey() {
            try {
                const tradeId = document.getElementById("keyTradeId").value;
                const key = document.getElementById("decryptKey").value;
                
                if (!tradeId || !key) {
                    showError("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
                    return;
                }

                showSuccess(`âœ“ è§£å¯†å¯†é’¥å·²ä¿å­˜`);
                document.getElementById("keyResult").innerHTML = `<strong>âœ“ ä¿å­˜æˆåŠŸ</strong><br>äº¤æ˜“ID: ${tradeId}`;
                document.getElementById("keyResult").className = "alert alert-success";
                document.getElementById("keyResult").style.display = "block";
            } catch (error) {
                showError("ä¿å­˜å¤±è´¥: " + error.message);
                document.getElementById("keyResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("keyResult").className = "alert alert-error";
                document.getElementById("keyResult").style.display = "block";
            }
        }

        async function finalizeAuction() {
            try {
                const tradeId = document.getElementById("finalizeTradeId").value;
                const allowanceAmount = document.getElementById("allowanceAmount").value;
                const additionalAmount = document.getElementById("additionalAmount").value;
                
                if (!tradeId || !allowanceAmount || !additionalAmount) {
                    showError("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
                    return;
                }

                showInfo("äº¤æ˜“å®Œæˆä¸­...");
                showSuccess(`âœ“ äº¤æ˜“å·²å®Œæˆ`);
                document.getElementById("finalizeResult").innerHTML = `
                    <strong>âœ“ äº¤æ˜“å®ŒæˆæˆåŠŸ</strong><br>
                    äº¤æ˜“ID: ${tradeId}<br>
                    è·å¾—ç¢³ç§¯åˆ†: ${allowanceAmount}<br>
                    æ”¯ä»˜é‡‘é¢: ${additionalAmount} USDT
                `;
                document.getElementById("finalizeResult").className = "alert alert-success";
                document.getElementById("finalizeResult").style.display = "block";
            } catch (error) {
                showError("å®Œæˆå¤±è´¥: " + error.message);
                document.getElementById("finalizeResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("finalizeResult").className = "alert alert-error";
                document.getElementById("finalizeResult").style.display = "block";
            }
        }

        async function refund() {
            try {
                const tradeId = document.getElementById("refundTradeId").value;
                
                if (!tradeId) {
                    showError("è¯·è¾“å…¥äº¤æ˜“ID");
                    return;
                }

                showInfo("ç”³è¯·é€€æ¬¾ä¸­...");
                showSuccess(`âœ“ é€€æ¬¾å·²ç”³è¯·`);
                document.getElementById("refundResult").innerHTML = `<strong>âœ“ é€€æ¬¾ç”³è¯·æˆåŠŸ</strong><br>äº¤æ˜“ID: ${tradeId}`;
                document.getElementById("refundResult").className = "alert alert-success";
                document.getElementById("refundResult").style.display = "block";
            } catch (error) {
                showError("ç”³è¯·å¤±è´¥: " + error.message);
                document.getElementById("refundResult").innerHTML = `<strong>âœ— å¤±è´¥</strong><br>${error.message}`;
                document.getElementById("refundResult").className = "alert alert-error";
                document.getElementById("refundResult").style.display = "block";
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener("load", init);
    </script>
</body>
</html>
